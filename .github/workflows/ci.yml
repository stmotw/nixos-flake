name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Use mock secrets for CI
        run: cp secrets.example.nix secrets.nix

      - name: Check Nix formatting
        run: nix run nixpkgs#alejandra -- --check .

      - name: Check shell scripts
        run: find . -name '*.sh' -type f | xargs --no-run-if-empty nix run nixpkgs#shellcheck --

      - name: Check flake
        run: nix flake check --no-build

      - name: Build NixOS configurations
        run: |
          nix build .#nixosConfigurations.arvad.config.system.build.toplevel --dry-run
          nix build .#nixosConfigurations.fiddlebender.config.system.build.toplevel --dry-run

      - name: Build Darwin configuration
        run: |
          # Darwin builds require macOS, so we only do a dry-run evaluation
          nix eval .#darwinConfigurations.ai71mac.config.system.build.toplevel --raw 2>/dev/null || echo "Darwin eval requires macOS runner"
